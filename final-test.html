<!DOCTYPE html>
<html>
  <head>
    <title>Final Math Processing Test</title>
    <base href="https://arxiv.org/abs/1706.03762" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
      }
      .result {
        background-color: #f0f8ff;
        padding: 10px;
        margin: 10px 0;
      }
      .expected {
        background-color: #f0fff0;
        padding: 10px;
        margin: 10px 0;
      }
      button {
        margin: 5px;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <h1>MarkDownload数学公式处理最终测试</h1>

    <div class="test-section">
      <h2>测试内容（来自debug.html）</h2>

      <h3>1. 行内数学公式</h3>
      <p>
        This is inline math:
        <math
          alttext="W^{Q}_{i}\in\mathbb{R}^{d_{\text{model}}\times d_{k}}"
          class="ltx_Math"
          display="inline"
          id="S3.SS2.SSS2.p4.1.m1.1"
          ><semantics id="S3.SS2.SSS2.p4.1.m1.1a"
            ><mrow
              id="S3.SS2.SSS2.p4.1.m1.1.1"
              xref="S3.SS2.SSS2.p4.1.m1.1.1.cmml"
              ><msubsup
                id="S3.SS2.SSS2.p4.1.m1.1.1.2"
                xref="S3.SS2.SSS2.p4.1.m1.1.1.2.cmml"
                ><mi
                  id="S3.SS2.SSS2.p4.1.m1.1.1.2.2.2"
                  xref="S3.SS2.SSS2.p4.1.m1.1.1.2.2.2.cmml"
                  >W</mi
                ><mi
                  id="S3.SS2.SSS2.p4.1.m1.1.1.2.3"
                  xref="S3.SS2.SSS2.p4.1.m1.1.1.2.3.cmml"
                  >i</mi
                ><mi
                  id="S3.SS2.SSS2.p4.1.m1.1.1.2.2.3"
                  xref="S3.SS2.SSS2.p4.1.m1.1.1.2.2.3.cmml"
                  >Q</mi
                ></msubsup
              ><mo
                id="S3.SS2.SSS2.p4.1.m1.1.1.1"
                xref="S3.SS2.SSS2.p4.1.m1.1.1.1.cmml"
                >∈</mo
              ><msup
                id="S3.SS2.SSS2.p4.1.m1.1.1.3"
                xref="S3.SS2.SSS2.p4.1.m1.1.1.3.cmml"
                ><mi
                  id="S3.SS2.SSS2.p4.1.m1.1.1.3.2"
                  xref="S3.SS2.SSS2.p4.1.m1.1.1.3.2.cmml"
                  >ℝ</mi
                ><mrow
                  id="S3.SS2.SSS2.p4.1.m1.1.1.3.3"
                  xref="S3.SS2.SSS2.p4.1.m1.1.1.3.3.cmml"
                  ><msub
                    id="S3.SS2.SSS2.p4.1.m1.1.1.3.3.2"
                    xref="S3.SS2.SSS2.p4.1.m1.1.1.3.3.2.cmml"
                    ><mi
                      id="S3.SS2.SSS2.p4.1.m1.1.1.3.3.2.2"
                      xref="S3.SS2.SSS2.p4.1.m1.1.1.3.3.2.2.cmml"
                      >d</mi
                    ><mtext
                      id="S3.SS2.SSS2.p4.1.m1.1.1.3.3.2.3"
                      xref="S3.SS2.SSS2.p4.1.m1.1.1.3.3.2.3a.cmml"
                      >model</mtext
                    ></msub
                  ><mo
                    id="S3.SS2.SSS2.p4.1.m1.1.1.3.3.1"
                    lspace="0.222em"
                    rspace="0.222em"
                    xref="S3.SS2.SSS2.p4.1.m1.1.1.3.3.1.cmml"
                    >×</mo
                  ><msub
                    id="S3.SS2.SSS2.p4.1.m1.1.1.3.3.3"
                    xref="S3.SS2.SSS2.p4.1.m1.1.1.3.3.3.cmml"
                    ><mi
                      id="S3.SS2.SSS2.p4.1.m1.1.1.3.3.3.2"
                      xref="S3.SS2.SSS2.p4.1.m1.1.1.3.3.3.2.cmml"
                      >d</mi
                    ><mi
                      id="S3.SS2.SSS2.p4.1.m1.1.1.3.3.3.3"
                      xref="S3.SS2.SSS2.p4.1.m1.1.1.3.3.3.3.cmml"
                      >k</mi
                    ></msub
                  ></mrow
                ></msup
              ></mrow
            ><annotation-xml
              encoding="MathML-Content"
              id="S3.SS2.SSS2.p4.1.m1.1b"
              ><!-- 省略大量MathML-Content --></annotation-xml
            ><annotation
              encoding="application/x-tex"
              id="S3.SS2.SSS2.p4.1.m1.1c"
              >W^{Q}_{i}\in\mathbb{R}^{d_{\text{model}}\times d_{k}}</annotation
            ><annotation
              encoding="application/x-llamapun"
              id="S3.SS2.SSS2.p4.1.m1.1d"
              >italic_W start_POSTSUPERSCRIPT italic_Q end_POSTSUPERSCRIPT
              start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT ∈ blackboard_R
              start_POSTSUPERSCRIPT italic_d start_POSTSUBSCRIPT model
              end_POSTSUBSCRIPT × italic_d start_POSTSUBSCRIPT italic_k
              end_POSTSUBSCRIPT end_POSTSUPERSCRIPT</annotation
            ></semantics
          ></math
        >
        and some more text.
      </p>

      <h3>2. 表格中的数学公式</h3>
      <table
        class="ltx_equationgroup ltx_eqn_align ltx_eqn_table"
        id="Sx1.EGx1"
      >
        <tbody id="S3.Ex1">
          <tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
            <td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
            <td class="ltx_td ltx_align_right ltx_eqn_cell">
              <math
                alttext="\displaystyle\mathrm{MultiHead}(Q,K,V)"
                class="ltx_Math"
                display="inline"
                id="S3.Ex1.m1.3"
              >
                <semantics id="S3.Ex1.m1.3a">
                  <mrow id="S3.Ex1.m1.3.4" xref="S3.Ex1.m1.3.4.cmml">
                    <mi id="S3.Ex1.m1.3.4.2" xref="S3.Ex1.m1.3.4.2.cmml"
                      >MultiHead</mi
                    >
                    <mo id="S3.Ex1.m1.3.4.1" xref="S3.Ex1.m1.3.4.1.cmml">⁢</mo>
                    <mrow id="S3.Ex1.m1.3.4.3.2" xref="S3.Ex1.m1.3.4.3.1.cmml">
                      <mo
                        id="S3.Ex1.m1.3.4.3.2.1"
                        stretchy="false"
                        xref="S3.Ex1.m1.3.4.3.1.cmml"
                        >(</mo
                      >
                      <mi id="S3.Ex1.m1.1.1" xref="S3.Ex1.m1.1.1.cmml">Q</mi>
                      <mo id="S3.Ex1.m1.3.4.3.2.2" xref="S3.Ex1.m1.3.4.3.1.cmml"
                        >,</mo
                      >
                      <mi id="S3.Ex1.m1.2.2" xref="S3.Ex1.m1.2.2.cmml">K</mi>
                      <mo id="S3.Ex1.m1.3.4.3.2.3" xref="S3.Ex1.m1.3.4.3.1.cmml"
                        >,</mo
                      >
                      <mi id="S3.Ex1.m1.3.3" xref="S3.Ex1.m1.3.3.cmml">V</mi>
                      <mo
                        id="S3.Ex1.m1.3.4.3.2.4"
                        stretchy="false"
                        xref="S3.Ex1.m1.3.4.3.1.cmml"
                        >)</mo
                      >
                    </mrow>
                  </mrow>
                  <annotation-xml encoding="MathML-Content" id="S3.Ex1.m1.3b"
                    ><!-- 省略 --></annotation-xml
                  >
                  <annotation encoding="application/x-tex" id="S3.Ex1.m1.3c"
                    >\displaystyle\mathrm{MultiHead}(Q,K,V)</annotation
                  >
                  <annotation
                    encoding="application/x-llamapun"
                    id="S3.Ex1.m1.3d"
                    >roman_MultiHead ( italic_Q , italic_K , italic_V
                    )</annotation
                  >
                </semantics>
              </math>
            </td>
            <td class="ltx_td ltx_align_left ltx_eqn_cell">
              <math
                alttext="\displaystyle=\mathrm{Concat}(\mathrm{head_{1}},...,\mathrm{head_{h}})W^{O}"
                class="ltx_Math"
                display="inline"
                id="S3.Ex1.m2.3"
              >
                <semantics id="S3.Ex1.m2.3a">
                  <!-- 省略大量MathML内容 -->
                  <annotation encoding="application/x-tex" id="S3.Ex1.m2.3c"
                    >\displaystyle=\mathrm{Concat}(\mathrm{head_{1}},...,\mathrm{head_{h}})W^{O}</annotation
                  >
                </semantics>
              </math>
            </td>
            <td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="test-section">
      <h2>测试控制</h2>
      <button onclick="runFullTest()">运行完整测试</button>
      <button onclick="showExpectedResults()">显示预期结果</button>
      <button onclick="clearResults()">清除结果</button>
    </div>

    <div class="test-section">
      <h2>测试结果</h2>
      <div id="test-results"></div>
    </div>

    <div class="expected">
      <h3>预期的Markdown输出：</h3>
      <p>
        <strong>行内公式：</strong>
        <code>$W^{Q}_{i}\in\mathbb{R}^{d_{\text{model}}\times d_{k}}$</code>
      </p>
      <p>
        <strong>表格公式1：</strong>
        <code>$\displaystyle\mathrm{MultiHead}(Q,K,V)$</code>
      </p>
      <p>
        <strong>表格公式2：</strong>
        <code
          >$\displaystyle=\mathrm{Concat}(\mathrm{head_{1}},...,\mathrm{head_{h}})W^{O}$</code
        >
      </p>
      <p><strong>表格应该变成：</strong></p>
      <pre>
| | $\displaystyle\mathrm{MultiHead}(Q,K,V)$ | $\displaystyle=\mathrm{Concat}(\mathrm{head_{1}},...,\mathrm{head_{h}})W^{O}$ | |
        </pre
      >
    </div>

    <script>
      function runFullTest() {
        const resultsDiv = document.getElementById("test-results");
        resultsDiv.innerHTML = "<h3>测试进行中...</h3>";

        let results = [];

        // 1. 检查math元素
        const mathElements = document.querySelectorAll("math");
        const mathWithAlttext = document.querySelectorAll("math[alttext]");

        results.push(`✅ 找到 ${mathElements.length} 个math元素`);
        results.push(`✅ 其中 ${mathWithAlttext.length} 个有alttext属性`);

        // 2. 模拟我们的处理逻辑
        const math = {};
        let processedCount = 0;

        mathWithAlttext.forEach((mathElement, index) => {
          const alttext = mathElement.getAttribute("alttext");
          const display = mathElement.getAttribute("display");
          const isInline = display !== "block";

          // 转换为Markdown
          let tex = alttext.trim();
          let markdown;

          if (isInline) {
            tex = tex.replaceAll("\n", " ");
            markdown = `$${tex}$`;
          } else {
            markdown = `$$\\n${tex}\\n$$`;
          }

          math[`math-${index + 1}`] = {
            tex: alttext.trim(),
            inline: isInline,
            markdown: markdown,
          };

          processedCount++;
          results.push(`📝 数学公式 ${index + 1}: ${markdown}`);
        });

        results.push(`✅ 成功处理 ${processedCount} 个数学公式`);

        // 3. 检查fallback情况
        const unprocessedMath = document.querySelectorAll(
          "math:not([alttext])"
        );
        if (unprocessedMath.length > 0) {
          results.push(
            `⚠️  还有 ${unprocessedMath.length} 个math元素需要fallback处理`
          );
          unprocessedMath.forEach((mathEl, index) => {
            const annotation = mathEl.querySelector(
              'annotation[encoding="application/x-tex"]'
            );
            if (annotation) {
              results.push(
                `📝 Fallback ${index + 1}: $${annotation.textContent}$`
              );
            }
          });
        }

        // 显示结果
        resultsDiv.innerHTML = `
                <div class="result">
                    <h3>测试结果：</h3>
                    ${results.map((r) => `<p>${r}</p>`).join("")}
                </div>
            `;

        return math;
      }

      function showExpectedResults() {
        const resultsDiv = document.getElementById("test-results");
        resultsDiv.innerHTML = `
                <div class="expected">
                    <h3>预期结果验证：</h3>
                    <p>✅ 行内公式应该转换为: <code>$W^{Q}_{i}\\in\\mathbb{R}^{d_{\\text{model}}\\times d_{k}}$</code></p>
                    <p>✅ 表格公式1应该转换为: <code>$\\displaystyle\\mathrm{MultiHead}(Q,K,V)$</code></p>
                    <p>✅ 表格公式2应该转换为: <code>$\\displaystyle=\\mathrm{Concat}(\\mathrm{head_{1}},...,\\mathrm{head_{h}})W^{O}$</code></p>
                    <p>✅ 所有复杂的MathML标记都会被移除</p>
                    <p>✅ 表格中只保留简洁的LaTeX公式</p>
                </div>
            `;
      }

      function clearResults() {
        document.getElementById("test-results").innerHTML = "";
      }

      // 页面加载时自动运行测试
      window.onload = function () {
        setTimeout(runFullTest, 1000);
      };
    </script>
  </body>
</html>
