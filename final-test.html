<!DOCTYPE html>
<html>
  <head>
    <title>Final Math Processing Test</title>
    <base href="https://arxiv.org/abs/1706.03762" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
      }
      .result {
        background-color: #f0f8ff;
        padding: 10px;
        margin: 10px 0;
      }
      .expected {
        background-color: #f0fff0;
        padding: 10px;
        margin: 10px 0;
      }
      button {
        margin: 5px;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <h1>MarkDownloadæ•°å­¦å…¬å¼å¤„ç†æœ€ç»ˆæµ‹è¯•</h1>

    <div class="test-section">
      <h2>æµ‹è¯•å†…å®¹ï¼ˆæ¥è‡ªdebug.htmlï¼‰</h2>

      <h3>1. è¡Œå†…æ•°å­¦å…¬å¼</h3>
      <p>
        This is inline math:
        <math
          alttext="W^{Q}_{i}\in\mathbb{R}^{d_{\text{model}}\times d_{k}}"
          class="ltx_Math"
          display="inline"
          id="S3.SS2.SSS2.p4.1.m1.1"
          ><semantics id="S3.SS2.SSS2.p4.1.m1.1a"
            ><mrow
              id="S3.SS2.SSS2.p4.1.m1.1.1"
              xref="S3.SS2.SSS2.p4.1.m1.1.1.cmml"
              ><msubsup
                id="S3.SS2.SSS2.p4.1.m1.1.1.2"
                xref="S3.SS2.SSS2.p4.1.m1.1.1.2.cmml"
                ><mi
                  id="S3.SS2.SSS2.p4.1.m1.1.1.2.2.2"
                  xref="S3.SS2.SSS2.p4.1.m1.1.1.2.2.2.cmml"
                  >W</mi
                ><mi
                  id="S3.SS2.SSS2.p4.1.m1.1.1.2.3"
                  xref="S3.SS2.SSS2.p4.1.m1.1.1.2.3.cmml"
                  >i</mi
                ><mi
                  id="S3.SS2.SSS2.p4.1.m1.1.1.2.2.3"
                  xref="S3.SS2.SSS2.p4.1.m1.1.1.2.2.3.cmml"
                  >Q</mi
                ></msubsup
              ><mo
                id="S3.SS2.SSS2.p4.1.m1.1.1.1"
                xref="S3.SS2.SSS2.p4.1.m1.1.1.1.cmml"
                >âˆˆ</mo
              ><msup
                id="S3.SS2.SSS2.p4.1.m1.1.1.3"
                xref="S3.SS2.SSS2.p4.1.m1.1.1.3.cmml"
                ><mi
                  id="S3.SS2.SSS2.p4.1.m1.1.1.3.2"
                  xref="S3.SS2.SSS2.p4.1.m1.1.1.3.2.cmml"
                  >â„</mi
                ><mrow
                  id="S3.SS2.SSS2.p4.1.m1.1.1.3.3"
                  xref="S3.SS2.SSS2.p4.1.m1.1.1.3.3.cmml"
                  ><msub
                    id="S3.SS2.SSS2.p4.1.m1.1.1.3.3.2"
                    xref="S3.SS2.SSS2.p4.1.m1.1.1.3.3.2.cmml"
                    ><mi
                      id="S3.SS2.SSS2.p4.1.m1.1.1.3.3.2.2"
                      xref="S3.SS2.SSS2.p4.1.m1.1.1.3.3.2.2.cmml"
                      >d</mi
                    ><mtext
                      id="S3.SS2.SSS2.p4.1.m1.1.1.3.3.2.3"
                      xref="S3.SS2.SSS2.p4.1.m1.1.1.3.3.2.3a.cmml"
                      >model</mtext
                    ></msub
                  ><mo
                    id="S3.SS2.SSS2.p4.1.m1.1.1.3.3.1"
                    lspace="0.222em"
                    rspace="0.222em"
                    xref="S3.SS2.SSS2.p4.1.m1.1.1.3.3.1.cmml"
                    >Ã—</mo
                  ><msub
                    id="S3.SS2.SSS2.p4.1.m1.1.1.3.3.3"
                    xref="S3.SS2.SSS2.p4.1.m1.1.1.3.3.3.cmml"
                    ><mi
                      id="S3.SS2.SSS2.p4.1.m1.1.1.3.3.3.2"
                      xref="S3.SS2.SSS2.p4.1.m1.1.1.3.3.3.2.cmml"
                      >d</mi
                    ><mi
                      id="S3.SS2.SSS2.p4.1.m1.1.1.3.3.3.3"
                      xref="S3.SS2.SSS2.p4.1.m1.1.1.3.3.3.3.cmml"
                      >k</mi
                    ></msub
                  ></mrow
                ></msup
              ></mrow
            ><annotation-xml
              encoding="MathML-Content"
              id="S3.SS2.SSS2.p4.1.m1.1b"
              ><!-- çœç•¥å¤§é‡MathML-Content --></annotation-xml
            ><annotation
              encoding="application/x-tex"
              id="S3.SS2.SSS2.p4.1.m1.1c"
              >W^{Q}_{i}\in\mathbb{R}^{d_{\text{model}}\times d_{k}}</annotation
            ><annotation
              encoding="application/x-llamapun"
              id="S3.SS2.SSS2.p4.1.m1.1d"
              >italic_W start_POSTSUPERSCRIPT italic_Q end_POSTSUPERSCRIPT
              start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT âˆˆ blackboard_R
              start_POSTSUPERSCRIPT italic_d start_POSTSUBSCRIPT model
              end_POSTSUBSCRIPT Ã— italic_d start_POSTSUBSCRIPT italic_k
              end_POSTSUBSCRIPT end_POSTSUPERSCRIPT</annotation
            ></semantics
          ></math
        >
        and some more text.
      </p>

      <h3>2. è¡¨æ ¼ä¸­çš„æ•°å­¦å…¬å¼</h3>
      <table
        class="ltx_equationgroup ltx_eqn_align ltx_eqn_table"
        id="Sx1.EGx1"
      >
        <tbody id="S3.Ex1">
          <tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
            <td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
            <td class="ltx_td ltx_align_right ltx_eqn_cell">
              <math
                alttext="\displaystyle\mathrm{MultiHead}(Q,K,V)"
                class="ltx_Math"
                display="inline"
                id="S3.Ex1.m1.3"
              >
                <semantics id="S3.Ex1.m1.3a">
                  <mrow id="S3.Ex1.m1.3.4" xref="S3.Ex1.m1.3.4.cmml">
                    <mi id="S3.Ex1.m1.3.4.2" xref="S3.Ex1.m1.3.4.2.cmml"
                      >MultiHead</mi
                    >
                    <mo id="S3.Ex1.m1.3.4.1" xref="S3.Ex1.m1.3.4.1.cmml">â¢</mo>
                    <mrow id="S3.Ex1.m1.3.4.3.2" xref="S3.Ex1.m1.3.4.3.1.cmml">
                      <mo
                        id="S3.Ex1.m1.3.4.3.2.1"
                        stretchy="false"
                        xref="S3.Ex1.m1.3.4.3.1.cmml"
                        >(</mo
                      >
                      <mi id="S3.Ex1.m1.1.1" xref="S3.Ex1.m1.1.1.cmml">Q</mi>
                      <mo id="S3.Ex1.m1.3.4.3.2.2" xref="S3.Ex1.m1.3.4.3.1.cmml"
                        >,</mo
                      >
                      <mi id="S3.Ex1.m1.2.2" xref="S3.Ex1.m1.2.2.cmml">K</mi>
                      <mo id="S3.Ex1.m1.3.4.3.2.3" xref="S3.Ex1.m1.3.4.3.1.cmml"
                        >,</mo
                      >
                      <mi id="S3.Ex1.m1.3.3" xref="S3.Ex1.m1.3.3.cmml">V</mi>
                      <mo
                        id="S3.Ex1.m1.3.4.3.2.4"
                        stretchy="false"
                        xref="S3.Ex1.m1.3.4.3.1.cmml"
                        >)</mo
                      >
                    </mrow>
                  </mrow>
                  <annotation-xml encoding="MathML-Content" id="S3.Ex1.m1.3b"
                    ><!-- çœç•¥ --></annotation-xml
                  >
                  <annotation encoding="application/x-tex" id="S3.Ex1.m1.3c"
                    >\displaystyle\mathrm{MultiHead}(Q,K,V)</annotation
                  >
                  <annotation
                    encoding="application/x-llamapun"
                    id="S3.Ex1.m1.3d"
                    >roman_MultiHead ( italic_Q , italic_K , italic_V
                    )</annotation
                  >
                </semantics>
              </math>
            </td>
            <td class="ltx_td ltx_align_left ltx_eqn_cell">
              <math
                alttext="\displaystyle=\mathrm{Concat}(\mathrm{head_{1}},...,\mathrm{head_{h}})W^{O}"
                class="ltx_Math"
                display="inline"
                id="S3.Ex1.m2.3"
              >
                <semantics id="S3.Ex1.m2.3a">
                  <!-- çœç•¥å¤§é‡MathMLå†…å®¹ -->
                  <annotation encoding="application/x-tex" id="S3.Ex1.m2.3c"
                    >\displaystyle=\mathrm{Concat}(\mathrm{head_{1}},...,\mathrm{head_{h}})W^{O}</annotation
                  >
                </semantics>
              </math>
            </td>
            <td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="test-section">
      <h2>æµ‹è¯•æ§åˆ¶</h2>
      <button onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
      <button onclick="showExpectedResults()">æ˜¾ç¤ºé¢„æœŸç»“æœ</button>
      <button onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
    </div>

    <div class="test-section">
      <h2>æµ‹è¯•ç»“æœ</h2>
      <div id="test-results"></div>
    </div>

    <div class="expected">
      <h3>é¢„æœŸçš„Markdownè¾“å‡ºï¼š</h3>
      <p>
        <strong>è¡Œå†…å…¬å¼ï¼š</strong>
        <code>$W^{Q}_{i}\in\mathbb{R}^{d_{\text{model}}\times d_{k}}$</code>
      </p>
      <p>
        <strong>è¡¨æ ¼å…¬å¼1ï¼š</strong>
        <code>$\displaystyle\mathrm{MultiHead}(Q,K,V)$</code>
      </p>
      <p>
        <strong>è¡¨æ ¼å…¬å¼2ï¼š</strong>
        <code
          >$\displaystyle=\mathrm{Concat}(\mathrm{head_{1}},...,\mathrm{head_{h}})W^{O}$</code
        >
      </p>
      <p><strong>è¡¨æ ¼åº”è¯¥å˜æˆï¼š</strong></p>
      <pre>
| | $\displaystyle\mathrm{MultiHead}(Q,K,V)$ | $\displaystyle=\mathrm{Concat}(\mathrm{head_{1}},...,\mathrm{head_{h}})W^{O}$ | |
        </pre
      >
    </div>

    <script>
      function runFullTest() {
        const resultsDiv = document.getElementById("test-results");
        resultsDiv.innerHTML = "<h3>æµ‹è¯•è¿›è¡Œä¸­...</h3>";

        let results = [];

        // 1. æ£€æŸ¥mathå…ƒç´ 
        const mathElements = document.querySelectorAll("math");
        const mathWithAlttext = document.querySelectorAll("math[alttext]");

        results.push(`âœ… æ‰¾åˆ° ${mathElements.length} ä¸ªmathå…ƒç´ `);
        results.push(`âœ… å…¶ä¸­ ${mathWithAlttext.length} ä¸ªæœ‰alttextå±æ€§`);

        // 2. æ¨¡æ‹Ÿæˆ‘ä»¬çš„å¤„ç†é€»è¾‘
        const math = {};
        let processedCount = 0;

        mathWithAlttext.forEach((mathElement, index) => {
          const alttext = mathElement.getAttribute("alttext");
          const display = mathElement.getAttribute("display");
          const isInline = display !== "block";

          // è½¬æ¢ä¸ºMarkdown
          let tex = alttext.trim();
          let markdown;

          if (isInline) {
            tex = tex.replaceAll("\n", " ");
            markdown = `$${tex}$`;
          } else {
            markdown = `$$\\n${tex}\\n$$`;
          }

          math[`math-${index + 1}`] = {
            tex: alttext.trim(),
            inline: isInline,
            markdown: markdown,
          };

          processedCount++;
          results.push(`ğŸ“ æ•°å­¦å…¬å¼ ${index + 1}: ${markdown}`);
        });

        results.push(`âœ… æˆåŠŸå¤„ç† ${processedCount} ä¸ªæ•°å­¦å…¬å¼`);

        // 3. æ£€æŸ¥fallbackæƒ…å†µ
        const unprocessedMath = document.querySelectorAll(
          "math:not([alttext])"
        );
        if (unprocessedMath.length > 0) {
          results.push(
            `âš ï¸  è¿˜æœ‰ ${unprocessedMath.length} ä¸ªmathå…ƒç´ éœ€è¦fallbackå¤„ç†`
          );
          unprocessedMath.forEach((mathEl, index) => {
            const annotation = mathEl.querySelector(
              'annotation[encoding="application/x-tex"]'
            );
            if (annotation) {
              results.push(
                `ğŸ“ Fallback ${index + 1}: $${annotation.textContent}$`
              );
            }
          });
        }

        // æ˜¾ç¤ºç»“æœ
        resultsDiv.innerHTML = `
                <div class="result">
                    <h3>æµ‹è¯•ç»“æœï¼š</h3>
                    ${results.map((r) => `<p>${r}</p>`).join("")}
                </div>
            `;

        return math;
      }

      function showExpectedResults() {
        const resultsDiv = document.getElementById("test-results");
        resultsDiv.innerHTML = `
                <div class="expected">
                    <h3>é¢„æœŸç»“æœéªŒè¯ï¼š</h3>
                    <p>âœ… è¡Œå†…å…¬å¼åº”è¯¥è½¬æ¢ä¸º: <code>$W^{Q}_{i}\\in\\mathbb{R}^{d_{\\text{model}}\\times d_{k}}$</code></p>
                    <p>âœ… è¡¨æ ¼å…¬å¼1åº”è¯¥è½¬æ¢ä¸º: <code>$\\displaystyle\\mathrm{MultiHead}(Q,K,V)$</code></p>
                    <p>âœ… è¡¨æ ¼å…¬å¼2åº”è¯¥è½¬æ¢ä¸º: <code>$\\displaystyle=\\mathrm{Concat}(\\mathrm{head_{1}},...,\\mathrm{head_{h}})W^{O}$</code></p>
                    <p>âœ… æ‰€æœ‰å¤æ‚çš„MathMLæ ‡è®°éƒ½ä¼šè¢«ç§»é™¤</p>
                    <p>âœ… è¡¨æ ¼ä¸­åªä¿ç•™ç®€æ´çš„LaTeXå…¬å¼</p>
                </div>
            `;
      }

      function clearResults() {
        document.getElementById("test-results").innerHTML = "";
      }

      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
      window.onload = function () {
        setTimeout(runFullTest, 1000);
      };
    </script>
  </body>
</html>
