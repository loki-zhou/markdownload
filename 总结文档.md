# MarkDownload V3 迁移总结

本文档旨在记录 MarkDownload 浏览器扩展从 Manifest V2 到 Manifest V3 的迁移过程, 包括核心目标, 已完成的修改以及后续的工作计划.

## 1. 迁移目标

核心目标是将整个扩展迁移到 Chrome Manifest V3, 以确保其在未来 Chrome 版本中的兼容性和可用性. 

迁移过程遵循一个重要原则: **在保证功能正常的前提下, 尽可能少地改动已经稳定运行的核心业务逻辑, 仅针对 V3 版本的强制性要求进行适配和修改.**

## 2. 已完成的改动

目前已完成对项目结构的初步改造和核心脚本的 V3 适配.

### 2.1. `manifest.json` 更新

清单文件是 V3 迁移的第一步, 主要改动如下:

- **`manifest_version`**: 已从 `2` 更新为 `3`.
- **`background`**: 
  - 放弃了 V2 的 `scripts` 数组.
  - 改为使用 `service_worker` 字段指向单一的 `background/background.js` 文件.
  - 经过尝试, 最终**没有**使用 `"type": "module"`, 而是采用 `importScripts()` 的方式加载依赖, 以避免修改 `Readability.js` 等第三方库的源码.
- **`action`**: V2 的 `browser_action` 已被重命名为 `action`.
- **权限 (`permissions` & `host_permissions`)**:
  - 将 `<all_urls>` 从 `permissions` 移至 `host_permissions`.
  - 在 `permissions` 中新增了 V3 所需的 `scripting` 和 `offscreen` 权限.
- **其他**: 移除了 Firefox 特有的 `browser_specific_settings` 和其他在 V3 中不推荐的字段.

### 2.2. Background Script (Service Worker) 迁移

`background.js` 的迁移是本次工作的核心, 主要挑战在于 Service Worker 的无状态, 事件驱动的生命周期以及受限的 API.

- **依赖加载**: 文件头部已添加 `importScripts()` 调用, 按顺序加载所有必要的依赖库 (`turndown.js`, `Readability.js` 等), 保证了全局环境的正确初始化.
- **API 调用更新**:
  - 将所有 `browser.tabs.executeScript` 的调用更新为 V3 的 `chrome.scripting.executeScript` 语法, 包括目标 (`target`) 和注入函数 (`func`) / 文件 (`files`) 的新格式.
- **网络请求**: `preDownloadImages` 函数中旧的 `XMLHttpRequest` 已被重构为基于 Promise 的 `fetch` API, 以适应 Service Worker 环境.
- **DOM 解析 (Offscreen Document)**:
  - 识别到 Service Worker 无法直接访问 `DOMParser`.
  - 创建了 `offscreen/offscreen.html` 和 `offscreen/offscreen.js` 作为专用的屏幕外文档.
  - 重构了 `getArticleFromDom` 函数, 将原始的 DOM 字符串通过消息传递发送到 Offscreen Document 进行解析, 解析完成后再将结构化数据传回 Service Worker. 这成功地将 DOM 操作与 Service Worker 主线程解耦.

### 2.3. 全局 API 适配与清理

在初步迁移后, 决定项目将**不再兼容 Firefox 等其他浏览器, 仅针对 Chrome Manifest V3** 进行适配. 基于此策略, 对整个项目进行了代码清理和 API 统一.

- **统一 API 命名空间**: 系统性地检查并替换了项目中所有残留的 `browser.*` API 调用, 将其全部更新为 Chrome 专用的 `chrome.*` API.
- **修复范围**:
  - `popup/popup.js`: 修复了 `browser.tabs.executeScript` 的错误调用, 并更新为 `chrome.scripting.executeScript`.
  - `contentScript/contentScript.js`: 修复了 `browser.runtime.getURL` 的调用.
  - `shared/context-menus.js`: 将所有 `browser.contextMenus` 的调用替换为 `chrome.contextMenus`.
  - `shared/default-options.js`: 将所有 `browser.storage` 和 `browser.downloads` 的调用替换为对应的 `chrome.*` API.
- **移除冗余依赖**: 从 `background/background.js` 的 `importScripts()` 调用中移除了不再需要的 `browser-polyfill.min.js`, 使代码更加精简.

### 2.4. Offscreen Document 重构与问题修复

在将 DOM 相关操作迁移到 Offscreen Document 后, 遇到了一系列由执行环境隔离引发的问题. 以下是详细的修复过程:

1.  **问题: `Readability is not defined`**
    - **原因**: `Readability.js` 在 `background.js` 中加载, 但并未在 `offscreen.html` 的独立环境中加载.
    - **解决**: 在 `offscreen.html` 中通过 `<script>` 标签明确引入 `Readability.js`.

2.  **问题: `document is not defined`**
    - **原因**: `turndown.js` 库依赖 DOM API, 无法在 Service Worker (`background.js`) 中直接运行.
    - **解决**: 将 `turndown.js` 的相关逻辑完全迁移到 Offscreen Document.
        - 从 `background.js` 的 `importScripts` 中移除 `turndown.js` 及其插件.
        - 在 `offscreen.html` 中引入 `turndown.js` 和 `turndown-plugin-gfm.js`.
        - 重构 `background.js` 中的 `turndown` 函数, 使其通过消息传递将 HTML 内容和配置发送到 Offscreen Document.
        - 在 `offscreen.js` 中添加消息监听器, 接收请求, 执行 Markdown 转换, 并将结果回传.

3.  **问题: `Identifier 'article' has already been declared`**
    - **原因**: 在 `offscreen.js` 的 `switch` 语句中, 不同的 `case` 块声明了同名常量 `article`, 但 `case` 默认不创建独立作用域.
    - **解决**: 为每个 `case` 块添加花括号 `{}` 以创建独立的块级作用域, 避免变量名冲突.

4.  **问题: `self.escape is not a function`**
    - **原因**: `turndown.js` 依赖一个在 `background.js` 中执行的初始化操作 (`TurndownService.prototype.defaultEscape = TurndownService.prototype.escape;`), 该操作在迁移时被遗漏.
    - **解决**: 将该初始化代码行添加到 `offscreen.js` 顶部, 确保 `turndown` 服务被正确配置.

5.  **问题: `validateUri is not defined`**
    - **原因**: 迁移到 `offscreen.js` 的 `turndown` 逻辑依赖多个在 `background.js` 中定义的辅助函数 (`validateUri`, `getImageFilename` 等).
    - **解决**: 将所有相关的辅助函数从 `background.js` 复制到 `offscreen.js`, 并从 `background.js` 中移除了不再需要的函数, 完成了解耦.

经过以上一系列修复, Offscreen Document 现在能够独立且完整地处理所有 DOM 解析和 Markdown 转换任务。

### 2.5. Service Worker 兼容性修复

在 V3 环境下进行初步测试时, 发现了一些由 Service Worker 环境限制导致的功能性错误. 以下是具体的修复过程:

1.  **问题: `URL.createObjectURL is not a function`**
    - **原因**: `background.js` 在 Service Worker 上下文中运行, 无法访问属于 `window` 对象的 `URL.createObjectURL` 和 `URL.revokeObjectURL` 方法.
    - **解决**: 对下载流程进行了重构, 以规避对这些 API 的直接调用:
        - **文件下载**: 在 `downloadMarkdown` 函数中, 将使用 `Blob` 和 `URL.createObjectURL` 创建下载链接的方式, 替换为直接生成 `data:` URI. 这种方法更简单, 且完全兼容 Service Worker.
        - **图片 Blob URL 管理**:
            - 修改了 `preDownloadImages` 函数, 在完成图片预下载后, 不再立即关闭 Offscreen Document, 确保为图片创建的 Blob URL 在后续操作中依然有效.
            - 修改了 `downloadListener` 函数, 使其不再尝试直接调用 `URL.revokeObjectURL`. 而是通过 `chrome.runtime.sendMessage` 向 Offscreen Document 发送一个 `'revoke-blob-url'` 请求.
            - 在 `offscreen/offscreen.js` 中添加了相应的消息监听器, 当收到请求时, 由 Offscreen Document 代为调用 `URL.revokeObjectURL` 来安全地释放 Blob URL, 从而避免了内存泄漏.

## 3. 后续计划

代码层面的 V3 适配和清理已基本完成. 下一阶段的重点是验证功能的完整性和稳定性.

1.  **全面功能测试**: 在 Chrome 浏览器中以“加载已解压的扩展程序”方式加载当前代码, **系统性地测试所有核心功能**, 包括:
    - 页面剪藏 (全文和选区).
    - Markdown 下载和复制.
    - 图片下载和链接替换.
    - 上下文菜单 (`contextMenus`) 的所有功能.
    - 选项页面的设置和保存.
2.  **问题定位与修复**: 根据测试结果, 详细记录出现的所有错误和功能异常. 预计可能会在异步操作, Service Worker 生命周期管理或与内容脚本的通信上遇到问题. 逐一进行调试和修复.
3.  **代码审查与优化**: 在功能稳定后, 回顾所有修改过的代码, 进行优化. 检查是否存在潜在的竞争条件, 确保对 `chrome.storage` 的使用是高效和正确的.
4.  **最终验证**: 在所有问题修复和代码优化后, 进行最终的回归测试, 确保扩展在 V3 环境下达到或超过 V2 版本的稳定性和性能.